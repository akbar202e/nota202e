<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Form Nota Pembayaran A4 — UPT Lab</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
   /* CSS UNTUK PRINT A4 */
    @media screen {
      #nota-print-area {
        display: none !important;
      }
    }

    /* Saat print, hanya area nota yang ditampilkan */
    @media print {
      body * {
        visibility: hidden;
      }
      #nota-print-area, #nota-print-area * {
        visibility: visible;
      }
      #nota-print-area {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: flex-start;
      }
      @page {
        size: A4 landscape;
        margin: 1.5cm;
      }
      .nota-a5-container {
        width: 48%;
        height: 100%;
        font-family: 'Times New Roman', Times, serif;
        color: #000;
        font-size: 10pt;
        line-height: 1.3;
        box-sizing: border-box;
      }
      .nota-a5-container .nota-header h1 { font-size: 14pt; }
      .nota-a5-container .nota-header p { font-size: 10pt; }
      .nota-a5-container .nota-title { font-size: 12pt; margin: 15px 0; }
      .nota-a5-container .nota-details { font-size: 10pt; }
      .nota-a5-container .item-table { font-size: 10pt; }
      .nota-a5-container .item-table th,
      .nota-a5-container .item-table td { padding: 4px 6px; }
      .nota-a5-container .total-section { font-size: 10pt; }
      .nota-a5-container .total-section table { width: 100%; }
      .nota-a5-container .total-section table table { width: 100%; }
      .nota-a5-container .total-section .signature { height: 50px; margin-top: 5px; margin-bottom: 5px; }
      .nota-a5-container .total-section .signature img { height: 50px; }
      .nota-a5-container .total-section .total-row th,
      .nota-a5-container .total-section .total-row td { font-size: 11pt; }
      .no-print { display: none !important; }

       body::after {
        content: "";
        position: fixed;
        top: 0;
        bottom: 0;
        left: 50%;
        width: 0;
        border-left: 1px dashed #b6b6b6;
        z-index: 9999;
    }


    /* DIHAPUS: Aturan umum #nota-print-area { display: none; } dipindahkan ke @media screen */

    /* --- CSS STYLE UNTUK KONTEN NOTA A4 --- */
    .nota-header {
      border-bottom: 2px solid #000;
      padding-bottom: 10px;
      margin-bottom: 10px;
    }
    
    .nota-title {
      text-align: center;
      font-size: 14pt;
      font-weight: bold;
      text-decoration: underline;
      margin-top: 20px;
      margin-bottom: 20px;
    }

    .nota-details {
      margin-bottom: 20px;
      font-size: 11pt;
    }
    .nota-details table {
      width: 100%;
      border-collapse: collapse;
    }
    .nota-details td {
      padding: 2px 0;
      vertical-align: top;
    }
    .nota-details td:first-child {
      width: 150px; /* Lebar label */
    }

    .item-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      font-size: 11pt;
    }
    .item-table th, .item-table td {
      border: 1px solid #000;
      padding: 6px 8px;
    }
    .item-table th {
      background-color: #f0f0f0;
      text-align: center;
    }
    .item-table td:nth-child(1),
    .item-table td:nth-child(2) {
      text-align: center;
    }
    .item-table td:nth-child(4),
    .item-table td:nth-child(5) {
      text-align: right;
    }
    
    .total-section {
      font-size: 11pt;
    }
    .total-section .terbilang {
      font-style: italic;
      font-weight: bold;
      padding: 10px;
      border: 1px solid #ccc;
      background-color: #f9f9f9;
      margin-bottom: 20px;
    }
    /* BARU: Style ini sekarang untuk tabel total di dalam td kanan */
    .total-section table table {
      width: 100%;
      border-collapse: collapse;
    }
    .total-section table table th {
      text-align: left;
      padding: 4px 8px;
      border-bottom: 1px solid #000;
    }
    .total-section table table td {
      text-align: right;
      padding: 4px 8px;
      border-bottom: 1px solid #000;
    }
    .total-section .total-row th,
    .total-section .total-row td {
      font-weight: bold;
      font-size: 12pt;
      border-top: 2px solid #000;
      border-bottom: 2px double #000;
    }

    /* Small spinner */
    .spinner { border-top-color: #2563eb; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-6 font-sans">

  <div class="max-w-7xl mx-auto">

    <div class="bg-white p-4 rounded shadow mb-6 no-print">
      <div class="flex flex-col md:flex-row md:items-center md:space-x-4">
        <div class="flex-grow">
          <h2 class="text-lg font-semibold">Cari Nota Lama</h2>
          <div class="mt-2 flex gap-2">
            <input id="cari-nota-input" type="text" placeholder="Masukkan No. Nota (contoh: 281025-01)" class="flex-grow border rounded p-2" />
            <button id="cari-nota-btn" class="bg-indigo-600 text-white px-4 py-2 rounded flex items-center">
              <span id="cari-nota-text">Cari</span>
              <div id="cari-nota-loader" class="spinner w-4 h-4 border-2 border-t-white rounded-full ml-2 hidden"></div>
            </button>
            <button id="reset-cari-btn" class="bg-gray-300 text-gray-800 px-3 py-2 rounded hidden">Buat Nota Baru</button>
          </div>
          <div id="cari-nota-message" class="mt-2 text-sm"></div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 gap-6">

      <div class="bg-white p-6 rounded shadow no-print">
        <h1 class="text-2xl font-bold mb-4">Formulir Nota Pembayaran</h1>

        <div class="bg-blue-50 border-l-4 border-blue-400 p-3 rounded mb-4 text-sm text-blue-700">
          <strong>PENTING:</strong> Website Nota Pembayaran di UPT LAB. Bahan Konstruksi Prov. Kalimantan Tengah, data disimpan kedalam spreadsheet <a href="https://docs.google.com/spreadsheets/d/1ltjzGCVOXHERxHIoCrFoYfp-EzsgeogwmenBFvBC7FA/edit?usp=sharing"><b>[disini]</b></a>
        </div>

        <form id="nota-form" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="text-sm font-medium">Nama Petugas</label>
              <input id="kasir" value="Tinawati" class="w-full border rounded p-2" required />
            </div>
            <div>
              <label class="text-sm font-medium">Pemohon (PT/CV)</label>
              <input id="pemohon" class="w-full border rounded p-2" required />
            </div>
          </div>

          <div>
            <label class="text-sm font-medium">Pekerjaan (Nama Paket)</label>
            <input id="pekerjaan" class="w-full border rounded p-2" required />
          </div>

          <hr />

          <div>
            <label class="text-sm font-medium">Cari Item</label>
            <input id="item-search" placeholder="Ketik nama barang..." class="w-full border rounded p-2" autocomplete="off" />
            <div id="search-results" class="z-50 bg-white border rounded mt-1 w-[100%] max-h-52 overflow-auto hidden"></div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-2">
            <input type="hidden" id="item-price" />
            <input type="hidden" id="item-name" />
            <div class="md:col-span-2">
              <label class="text-sm font-medium">Item Terpilih</label>
              <input id="item-selected-display" disabled class="w-full bg-gray-100 border rounded p-2" />
            </div>
            <div>
              <label class="text-sm font-medium">Jumlah</label>
              <input id="item-qty" type="number" min="1" value="1" class="w-full border rounded p-2" />
            </div>
          </div>

          <div>
            <button type="button" id="tambah-item-btn" class="bg-blue-600 text-white px-4 py-2 rounded">Tambah Item</button>
          </div>

          <div>
            <h3 class="font-semibold">Daftar Item Dibeli</h3>
            <div id="cart-items" class="mt-2 border rounded p-3 min-h-[60px] text-sm text-gray-700">
              <p id="cart-empty" class="text-gray-500">Belum ada item.</p>
            </div>
          </div>

          <div class="text-right text-xl font-bold">
            Total: <span id="total-harga">Rp 0</span>
          </div>

          <hr />

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-medium">Metode Pembayaran</label>
              <div class="mt-2 space-x-3">
                <label><input type="radio" name="metode" value="Cash" checked class="mr-1"> Cash</label>
                <label><input type="radio" name="metode" value="Transfer" class="mr-1"> Transfer</label>
              </div>
              <div id="bank-input" class="mt-2 hidden">
                <label class="text-sm font-medium">Nama Bank</label>
                <input id="nama-bank" class="w-full border rounded p-2" />
              </div>
            </div>

            <div>
              <label class="text-sm font-medium">Jumlah Bayar (Rp)</label>
              <input id="jumlah-bayar" type="number" placeholder="0" class="w-full border rounded p-2" />
            </div>
          </div>

          <div id="form-message" class="text-sm mt-2"></div>

          <div class="flex flex-wrap gap-2 mt-4">
            <button type="button" id="save-btn" class="bg-green-600 text-white px-4 py-2 rounded flex items-center">
              <span id="save-text">Simpan</span>
              <div id="save-loader" class="spinner w-4 h-4 border-2 border-t-white rounded-full ml-2 hidden"></div>
            </button>
            
            <button type="button" id="print-btn" class="bg-blue-600 text-white px-4 py-2 rounded">Cetak A4</button>
            
            <button type="button" id="download-word-btn" class="bg-purple-600 text-white px-4 py-2 rounded">Download Word (.doc)</button>

            <button type="button" id="reset-btn" class="bg-gray-500 text-white px-4 py-2 rounded">Reset</button>

          </div>

        </form>
      </div>
    </div>

    <div id="nota-print-area" aria-hidden="true">
      </div>

  </div>

  <script>
    /*************************************************************************
     * PENTING: GANTI nilai webAppUrl di bawah ini dengan URL Web App GAS kamu
     *************************************************************************/
    const webAppUrl = 'https://script.google.com/macros/s/AKfycbx2iC-Vv-T-dDtUMxMWugqEZM5bpGtCNLV2I8xYINiJTs0zqZj3BX4m1sruvhAB1_l7Fg/exec';

    // Utility
    const $ = id => document.getElementById(id);
    const q = s => document.querySelector(s);
    const rupiah = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n);

    // State
    let itemMasterList = [];
    let cart = [];
    let totalKeseluruhan = 0;
    let formLockedForNota = false;
    let currentNotaData = { // Menyimpan data nota untuk preview A4
      nomorNota: 'AUTO',
      tanggal: new Date().toISOString(),
    }; 

    // Elemen Form
    const itemSearchEl = $('item-search');
    const searchResultsEl = $('search-results');
    const itemSelectedDisplayEl = $('item-selected-display');
    const itemPriceEl = $('item-price');
    const itemNameHiddenEl = $('item-name');
    const itemQtyEl = $('item-qty');
    const tambahItemBtn = $('tambah-item-btn');
    const cartItemsEl = $('cart-items');
    const cartEmptyEl = $('cart-empty');
    const totalHargaEl = $('total-harga');
    const metodeEls = document.getElementsByName('metode');
    const bankInputEl = $('bank-input');
    const namaBankEl = $('nama-bank');
    const jumlahBayarEl = $('jumlah-bayar');

    // Buttons / controls
    const saveBtn = $('save-btn');
    const saveLoader = $('save-loader');
    const saveText = $('save-text');
    const printBtn = $('print-btn');
    const downloadWordBtn = $('download-word-btn');
    const resetBtn = $('reset-btn');

    // Cari Nota
    const cariNotaInput = $('cari-nota-input');
    const cariNotaBtn = $('cari-nota-btn');
    const cariNotaText = $('cari-nota-text');
    const cariNotaLoader = $('cari-nota-loader');
    const cariNotaMessage = $('cari-nota-message');
    const resetCariBtn = $('reset-cari-btn');

    // Print element
    const notaPrintArea = $('nota-print-area');

    // Form message
    const formMessage = $('form-message');

    // Inisialisasi: ambil daftar barang
    document.addEventListener('DOMContentLoaded', () => {
      if (!webAppUrl || webAppUrl.startsWith('MASUKKAN_URL')) {
        console.warn('webAppUrl belum diisi.');
      } else {
        fetchItemsFromSheet();
      }
      addEventListeners();
      renderCart(); // inisialisasi
      updateA4Preview(); // Siapkan area print
    });

    /* ------------------ FETCH ITEMS ------------------ */
    function fetchItemsFromSheet() {
      fetch(`${webAppUrl}?action=getItems`)
        .then(res => res.json())
        .then(data => {
          if (Array.isArray(data)) {
            itemMasterList = data;
            console.log('Daftar barang dimuat:', itemMasterList);
          } else {
            console.error('Error saat fetch items:', data.message || 'Format data tidak dikenal');
          }
        }).catch(err => {
          console.error('Gagal ambil daftar barang:', err);
        });
    }

    /* ------------------ EVENT LISTENERS ------------------ */
    function addEventListeners() {
      // Item search
      itemSearchEl.addEventListener('keyup', handleItemSearch);
      searchResultsEl.addEventListener('click', handleItemSelect);
      document.addEventListener('click', handleClickOutside);

      // Add item
      tambahItemBtn.addEventListener('click', handleAddItem);

      // Payment method change
      metodeEls.forEach(radio => radio.addEventListener('change', handlePaymentMethodChange));

      // Form buttons
      saveBtn.addEventListener('click', handleSave);
      printBtn.addEventListener('click', handlePrint);
      downloadWordBtn.addEventListener('click', handleDownloadWord);
      resetBtn.addEventListener('click', handleReset);

      // Cari Nota
      cariNotaBtn.addEventListener('click', handleCariNota);
      resetCariBtn.addEventListener('click', resetCariForm);

      // Update area print saat mengetik di form
      ['kasir', 'pemohon', 'pekerjaan', 'jumlah-bayar', 'nama-bank'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', updateA4Preview);
      });
      metodeEls.forEach(radio => radio.addEventListener('change', updateA4Preview));
    }

    /* ------------------ ITEM SEARCH & SELECT ------------------ */
    function handleItemSearch(e) {
      if (formLockedForNota) return;
      const qtext = e.target.value.trim().toLowerCase();
      if (qtext.length < 1) { searchResultsEl.innerHTML = ''; searchResultsEl.classList.add('hidden'); return; }
      const filtered = itemMasterList.filter(it => it[0].toString().toLowerCase().includes(qtext));
      if (filtered.length === 0) {
        searchResultsEl.innerHTML = `<div class="p-2 text-gray-500">Item tidak ditemukan</div>`;
        searchResultsEl.classList.remove('hidden');
        return;
      }
      searchResultsEl.innerHTML = filtered.map(it => {
        return `<div class="p-2 hover:bg-gray-100 cursor-pointer" data-name="${escapeHtml(it[0])}" data-price="${it[1]}">
          <strong>${escapeHtml(it[0])}</strong> — ${rupiah(it[1])}
        </div>`;
      }).join('');
      searchResultsEl.classList.remove('hidden');
    }

    function handleItemSelect(e) {
      if (formLockedForNota) return;
      const node = e.target.closest('div[data-name]');
      if (!node) return;
      const name = node.dataset.name;
      const price = node.dataset.price;
      itemSelectedDisplayEl.value = `${name} (${rupiah(price)})`;
      itemNameHiddenEl.value = name;
      itemPriceEl.value = price;
      itemSearchEl.value = '';
      searchResultsEl.classList.add('hidden');
      itemQtyEl.focus();
    }

    function handleClickOutside(e) {
      if (!itemSearchEl.contains(e.target) && !searchResultsEl.contains(e.target)) {
        searchResultsEl.classList.add('hidden');
      }
    }

    /* ------------------ CART HANDLING ------------------ */
    function handleAddItem() {
      if (formLockedForNota) return;
      const name = itemNameHiddenEl.value || itemSelectedDisplayEl.value.split(' (')[0];
      const price = parseFloat(itemPriceEl.value || 0);
      const qty = parseInt(itemQtyEl.value || 1, 10);
      if (!name || isNaN(price) || isNaN(qty) || qty < 1) {
        alert('Silakan pilih item dan masukkan jumlah yang valid.');
        return;
      }
      cart.push({ name, price, qty, total: price * qty });
      // reset item-select fields
      itemSelectedDisplayEl.value = '';
      itemNameHiddenEl.value = '';
      itemPriceEl.value = '';
      itemQtyEl.value = 1;
      renderCart();
      updateA4Preview();
    }

    function renderCart() {
      cartItemsEl.innerHTML = '';
      if (cart.length === 0) {
        cartItemsEl.appendChild(cartEmptyEl);
        totalKeseluruhan = 0;
      } else {
        if (cartEmptyEl.parentNode) cartEmptyEl.remove();
        totalKeseluruhan = 0;
        cart.forEach((it, idx) => {
          totalKeseluruhan += it.total;
          const row = document.createElement('div');
          row.className = 'flex justify-between items-center p-2 bg-white border-b';
          row.innerHTML = `<div>
              <span class="font-medium">${escapeHtml(it.name)}</span>
              <div class="text-xs text-gray-500">${it.qty} x ${rupiah(it.price)}</div>
            </div>
            <div class="flex items-center gap-2">
              <span class="font-medium">${rupiah(it.total)}</span>
              <button class="text-red-500 hover:text-red-700" data-idx="${idx}" title="Hapus">&times;</button>
            </div>`;
          cartItemsEl.appendChild(row);
        });
        // add delete listeners
        cartItemsEl.querySelectorAll('button[data-idx]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            if (formLockedForNota) return;
            const idx = parseInt(e.currentTarget.dataset.idx, 10);
            cart.splice(idx, 1);
            renderCart();
            updateA4Preview();
          });
        });
      }
      totalHargaEl.textContent = rupiah(totalKeseluruhan);
      jumlahBayarEl.value = totalKeseluruhan || '';
      updateA4Preview(); // Pastikan area print juga terupdate
    }

    /* ------------------ PAYMENT METHOD ------------------ */
    function handlePaymentMethodChange(e) {
      if (formLockedForNota) return;
      if (e.target.value === 'Transfer') {
        bankInputEl.classList.remove('hidden');
        namaBankEl.required = true;
      } else {
        bankInputEl.classList.add('hidden');
        namaBankEl.required = false;
        namaBankEl.value = '';
      }
      updateA4Preview();
    }

    /* ------------------ POPULATE A4 PREVIEW (AREA PRINT) ------------------ */
    function updateA4Preview(dataFromSheet = null) {
      let data;

      if (dataFromSheet) {
        // Mode 'Cari Nota'
        data = {
          nomorNota: dataFromSheet.nomorNota,
          tanggal: new Date(dataFromSheet.tanggal).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }),
          kasir: dataFromSheet.kasir,
          pemohon: dataFromSheet.pemohon,
          pekerjaan: dataFromSheet.pekerjaan,
          cart: dataFromSheet.cart || [],
          totalKeseluruhan: dataFromSheet.totalKeseluruhan || 0,
          metodePembayaran: dataFromSheet.metodePembayaran || 'Cash',
          bank: dataFromSheet.bank || '',
          jumlahBayar: dataFromSheet.jumlahBayar || 0
        };
        currentNotaData.nomorNota = data.nomorNota;
        currentNotaData.tanggal = dataFromSheet.tanggal;
      } else {
        // Mode 'Nota Baru'
        const metode = document.querySelector('input[name="metode"]:checked')?.value || 'Cash';
        data = {
          nomorNota: currentNotaData.nomorNota,
          tanggal: new Date(currentNotaData.tanggal).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }),
          kasir: $('kasir').value,
          pemohon: $('pemohon').value,
          pekerjaan: $('pekerjaan').value,
          cart: cart,
          totalKeseluruhan: totalKeseluruhan,
          metodePembayaran: metode,
          bank: namaBankEl.value,
          jumlahBayar: parseFloat(jumlahBayarEl.value || 0)
        };
      }
      
      const terbilangStr = `Terbilang: ${terbilang(data.totalKeseluruhan)} rupiah`;

      // Build item rows
      let itemRows = '';
      data.cart.forEach((item, index) => {
        itemRows += `
          <tr>
            <td>${index + 1}</td>
            <td>${escapeHtml(item.name)}</td>
            <td>${item.qty}</td>
            <td>${rupiah(item.price)}</td>
            <td>${rupiah(item.total)}</td>
          </tr>
        `;
      });
      if (data.cart.length === 0) {
        itemRows = '<tr><td colspan="5" style="text-align:center;"><i>Belum ada item...</i></td></tr>';
      }

      // Build payment info
      const metodeStr = data.metodePembayaran + (data.metodePembayaran === 'Transfer' && data.bank ? ` (${data.bank})` : '');

      // Build HTML untuk *satu* nota
      const notaHtml = `
        <div class="nota-header">
          <table style="width: 100%; border-collapse: collapse;">
            <tbody>
              <tr>
                <td style="width: 110px; vertical-align: top; padding: 0;">
                  <img src="https://upload.wikimedia.org/wikipedia/commons/4/4e/Coat_of_arms_of_Central_Kalimantan.svg" alt="Logo Perusahaan" style="max-width: 180px; max-height: 100px; filter: grayscale(100%);">
                </td>
                <td style="text-align: center; vertical-align: top; padding: 0;">
                  <h1 style="font-size: 16pt; font-weight: bold; margin: 0;">UPT LAB. BAHAN KONSTRUKSI</h1>
                  <p style="font-size: 11pt; margin: 2px 0;">Dinas Pekerjaan Umum dan Penataan Ruang</p>
                  <p style="font-size: 11pt; margin: 2px 0;">Provinsi Kalimantan Tengah</p>
                  <p style="font-size: 11pt; margin: 2px 0;">Jalan Tjilik Riwut km. 3 Palangka Raya | Telp. (0536) 3222607</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <h2 class="nota-title">NOTA PEMBAYARAN</h2>
        
        <div class="nota-details">
          <table>
            <tr>
              <td>No. Nota</td>
              <td>: <strong id="nota-no-a4">${escapeHtml(data.nomorNota)}</strong></td>
            </tr>
            <tr>
              <td>Tanggal</td>
              <td>: ${escapeHtml(data.tanggal)}</td>
            </tr>
            <tr>
              <td>Diterima dari</td>
              <td>: ${escapeHtml(data.pemohon)}</td>
            </tr>
            <tr>
              <td>Pekerjaan</td>
              <td>: ${escapeHtml(data.pekerjaan)}</td>
            </tr>
          </table>
        </div>

        <table class="item-table">
          <thead>
            <tr>
              <th style="width: 5%;">No.</th>
              <th style="width: 45%;">Uraian / Nama Item</th>
              <th style="width: 10%;">Qty</th>
              <th style="width: 20%;">Harga Satuan</th>
              <th style="width: 20%;">Jumlah</th>
            </tr>
          </thead>
          <tbody>
            ${itemRows}
          </tbody>
        </table>

        <div class="total-section">
          <div class="terbilang">
            ${terbilangStr}
          </div>
          
          <table style="width: 100%; margin-top: 20px; border-collapse: collapse;">
            <tbody>
              <tr>
                <td style="width: 50%; vertical-align: top; text-align: center; font-size: 11pt; padding-right: 80px;">
                  <div>Hormat kami,</div>
                  <div class="signature" style="height: 80px; margin-top: 10px; margin-bottom: 10px;">
                    <img src="" style="height: 80px; margin: 0 auto;" />
                  </div>
                  <div class="nama-petugas" style="font-weight: bold; text-decoration: underline;">${escapeHtml(data.kasir)}</div>
                  <div>Petugas Lab</div>
                </td>
                
                <td style="width: 50%; vertical-align: top;">
                  <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                      <th style="text-align: left; padding: 4px 8px; border-bottom: 1px solid #000;">Metode Bayar</th>
                      <td style="text-align: right; padding: 4px 8px; border-bottom: 1px solid #000;">${escapeHtml(metodeStr)}</td>
                    </tr>
                    <tr>
                      <th style="text-align: left; padding: 4px 8px; border-bottom: 1px solid #000;">Jumlah Bayar</th>
                      <td style="text-align: right; padding: 4px 8px; border-bottom: 1px solid #000;">${rupiah(data.jumlahBayar)}</td>
                    </tr>
                    <tr class="total-row" style="font-weight: bold; font-size: 12pt;">
                      <th style="text-align: left; padding: 4px 8px; border-top: 2px solid #000; border-bottom: 2px double #000;">TOTAL</th>
                      <td style="text-align: right; padding: 4px 8px; border-top: 2px solid #000; border-bottom: 2px double #000;">${rupiah(data.totalKeseluruhan)}</td>
                    </tr>
                  </table>
                </td>
              </tr>
            </tbody>
          </table>
          <div style="clear:both;"></div>
        </div>
        `;

      // Inject HTML 2x ke area print
      const finalPrintHtml = `
        <div class="nota-a5-container">
          ${notaHtml}
        </div>
        <div class="nota-a5-container">
          ${notaHtml}
        </div>
      `;
      
      notaPrintArea.innerHTML = finalPrintHtml;
    }


    /* ------------------ SAVE TO SHEET (POST) ------------------ */
    async function handleSave() {
      if (!webAppUrl || webAppUrl.startsWith('MASUKKAN_URL')) {
        alert('Harap masukkan URL Web App Google Apps Script Anda pada variabel webAppUrl.');
        return;
      }
      if (cart.length === 0) { 
        alert('Keranjang masih kosong.'); 
        return; 
      }

      setLoading(true, 'save');
      formMessage.textContent = 'Menyimpan data ke Google Sheet...';
      const itemSummary = cart.map(it => `${it.name} (${it.qty})`).join(', ');

      const formData = {
        kasir: $('kasir').value,
        pemohon: $('pemohon').value,
        pekerjaan: $('pekerjaan').value,
        cart: cart,
        totalKeseluruhan: totalKeseluruhan,
        metodePembayaran: document.querySelector('input[name="metode"]:checked').value,
        bank: $('nama-bank').value || null,
        jumlahBayar: parseFloat($('jumlah-bayar').value) || 0,
        itemSummary: itemSummary
      };

      try {
        const res = await fetch(webAppUrl, {
          method: 'POST',
          mode: 'cors',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(formData)
        });
        const data = await res.json();
        if (data.status === 'success') {
          formMessage.textContent = `Sukses! Nota ${data.nomorNota} berhasil disimpan.`;
          formMessage.className = 'text-sm text-green-600';
          currentNotaData.nomorNota = data.nomorNota;
          currentNotaData.tanggal = new Date().toISOString();
          updateA4Preview(); // Update area print dengan nomor nota baru
        } else {
          throw new Error(data.message || 'Gagal menyimpan nota');
        }
      } catch (err) {
        formMessage.textContent = `Error: ${err.message}`;
        formMessage.className = 'text-sm text-red-600';
      } finally {
        setLoading(false, 'save');
      }
    }


    /* ------------------ PRINT & DOWNLOAD ------------------ */
    function handlePrint() {
      updateA4Preview(); 
      setTimeout(() => {
        window.print();
      }, 200);
    }

    function handleDownloadWord() {
      updateA4Preview();
      const nomor = currentNotaData.nomorNota || 'NOTA';
      const pemohon = $('pemohon').value || 'Customer';
      const content = notaPrintArea.innerHTML;

      // Gabungkan menjadi format HTML yang bisa dibaca Word
      const htmlString = `
        <html xmlns:v="urn:schemas-microsoft-com:vml"
        xmlns:o="urn:schemas-microsoft-com:office:office"
        xmlns:w="urn:schemas-microsoft-com:office:word"
        xmlns:m="http://schemas.microsoft.com/office/2004/12/omml"
        xmlns="http://www.w3.org/TR/REC-html40">
        <head>
          <meta charset="utf-8">
          <title>Nota Pembayaran</title>
          <style>
            body { font-family: 'Times New Roman', Times, serif; }
            @page { 
              size: A4 landscape; 
              mso-page-orientation: landscape; 
              margin: 1.5cm; 
            }
            
            /* Salin SEMUA style nota ke sini */
            .nota-header { border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 10px; }
            .nota-title { text-align: center; font-size: 14pt; font-weight: bold; text-decoration: underline; margin-top: 20px; margin-bottom: 20px; }
            .nota-details { margin-bottom: 20px; font-size: 11pt; }
            .nota-details table { width: 100%; border-collapse: collapse; }
            .nota-details td { padding: 2px 0; vertical-align: top; }
            .nota-details td:first-child { width: 150px; }
            .item-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 11pt; }
            .item-table th, .item-table td { border: 1px solid #000; padding: 6px 8px; }
            .item-table th { background-color: #f0f0f0; text-align: center; }
            .item-table td:nth-child(1), .item-table td:nth-child(2) { text-align: center; }
            .item-table td:nth-child(4), .item-table td:nth-child(5) { text-align: right; }
            .total-section { font-size: 11pt; }
            .total-section .terbilang { font-style: italic; font-weight: bold; padding: 10px; border: 1px solid #ccc; background-color: #f9f9f9; margin-bottom: 20px; }
            
            /* BARU: Style untuk TTD + Total Gabungan */
            .total-section table { width: 100%; border-collapse: collapse; }
            .total-section .signature { height: 80px; margin-top: 10px; margin-bottom: 10px; }
            .total-section .signature img { height: 80px; }
            .total-section .nama-petugas { font-weight: bold; text-decoration: underline; }
            .total-section table table { width: 100%; } /* Tabel total di dalam */
            .total-section table table th { text-align: left; padding: 4px 8px; border-bottom: 1px solid #000; }
            .total-section table table td { text-align: right; padding: 4px 8px; border-bottom: 1px solid #000; }
            .total-section .total-row th, .total-section .total-row td { font-weight: bold; font-size: 12pt; border-top: 2px solid #000; border-bottom: 2px double #000; }

            /* DIHAPUS: .nota-footer tidak dipakai lagi */
            
            /* Style untuk layout A5 ganda */
            #nota-print-area { display: flex; flex-direction: row; justify-content: space-between; width: 100%; }
            .nota-a5-container { 
              width: 48%; height: 100%; 
              font-size: 10pt; line-height: 1.3; 
              font-family: 'Times New Roman', Times, serif; 
            }
            .nota-a5-container .nota-header h1 { font-size: 14pt; }
            .nota-a5-container .nota-header p { font-size: 10pt; }
            .nota-a5-container .nota-title { font-size: 12pt; margin: 15px 0; }
            .nota-a5-container .nota-details { font-size: 10pt; }
            .nota-a5-container .item-table { font-size: 10pt; }
            .nota-a5-container .item-table th, 
            .nota-a5-container .item-table td { padding: 4px 6px; }
            .nota-a5-container .total-section { font-size: 10pt; }
            .nota-a5-container .total-section .signature { height: 50px; }
            .nota-a5-container .total-section .signature img { height: 50px; }
            
            /* Tambahan untuk Word */
            table { border-collapse: collapse; }
            div { clear: both; } /* Mencegah float-related issue */
          </style>
        </head>
        <body>
          <div id="nota-print-area">
            ${content}
          </div>
        </body>
        </html>`;

      const blob = new Blob([htmlString], {
        type: 'application/msword'
      });
      
      saveAs(blob, `Nota_${nomor}_${pemohon}.doc`);
    }

    /* ------------------ SEARCH NOTA LAMA ------------------ */
    function setLoading(isLoading, type='cari') {
      if (type === 'cari') {
        $('cari-nota-btn').disabled = isLoading;
        if (isLoading) { cariNotaText.classList.add('hidden'); cariNotaLoader.classList.remove('hidden'); }
        else { cariNotaText.classList.remove('hidden'); cariNotaLoader.classList.add('hidden'); }
      } else if (type === 'save') {
        saveBtn.disabled = isLoading;
        if (isLoading) { saveText.classList.add('hidden'); saveLoader.classList.remove('hidden'); }
        else { saveText.classList.remove('hidden'); saveLoader.classList.add('hidden'); }
      }
    }

    function handleCariNota() {
      const nomor = cariNotaInput.value.trim();
      if (!nomor) {
        cariNotaMessage.textContent = 'Silakan masukkan Nomor Nota.';
        cariNotaMessage.className = 'text-sm text-red-600';
        return;
      }
      if (!webAppUrl || webAppUrl.startsWith('MASUKKAN_URL')) {
        alert('Harap masukkan URL Web App Google Apps Script Anda pada variabel webAppUrl.');
        return;
      }
      setLoading(true, 'cari');
      cariNotaMessage.textContent = 'Mencari nota...';
      cariNotaMessage.className = 'text-sm text-blue-600';
      
      fetch(`${webAppUrl}?action=getNotaByNomor&nomorNota=${encodeURIComponent(nomor)}`)
        .then(r => r.json())
        .then(data => {
          setLoading(false, 'cari');
          if (data.status === 'success' && data.notaData) {
            cariNotaMessage.textContent = `Nota ${data.notaData.nomorNota} ditemukan.`;
            cariNotaMessage.className = 'text-sm text-green-600';
            populateFormFromData(data.notaData);
            updateA4Preview(data.notaData);
            resetCariBtn.classList.remove('hidden');
            setFormReadOnly(true);
          } else {
            throw new Error(data.message || 'Nota tidak ditemukan');
          }
        })
        .catch(err => {
          setLoading(false, 'cari');
          cariNotaMessage.textContent = `Error: ${err.message}`;
          cariNotaMessage.className = 'text-sm text-red-600';
          console.error(err);
        });
    }
    
    function populateFormFromData(data) {
        cart = (data.cart || []).map(i => ({...i}));
        totalKeseluruhan = data.totalKeseluruhan || 0;
        totalHargaEl.textContent = rupiah(totalKeseluruhan);
        jumlahBayarEl.value = data.jumlahBayar || '';
        $('kasir').value = data.kasir || '';
        $('pemohon').value = data.pemohon || '';
        $('pekerjaan').value = data.pekerjaan || '';
        const metodeVal = (data.metodePembayaran || 'Cash');
        document.querySelectorAll('input[name="metode"]').forEach(r => {
          r.checked = (r.value === metodeVal);
        });
        if (metodeVal === 'Transfer') {
          bankInputEl.classList.remove('hidden');

          namaBankEl.value = data.bank || '';
        } else {
          bankInputEl.classList.add('hidden');
          namaBankEl.value = '';
        }
        renderCart();
    }

    function resetCariForm() {
      setFormReadOnly(false);
      resetCariBtn.classList.add('hidden');
      cariNotaInput.value = '';
      cariNotaMessage.textContent = '';
      handleReset(false);
    }

    /* ------------------ RESET FORM ------------------ */
    function handleReset(useConfirmation = true) {
      if (useConfirmation && !confirm('Reset formulir dan kosongkan keranjang?')) return;
      
      cart = [];
      totalKeseluruhan = 0;
      currentNotaData = {
        nomorNota: 'AUTO',
        tanggal: new Date().toISOString(),
      };
      
      $('nota-form').reset();
      setFormReadOnly(false);
      renderCart(); // Ini akan memanggil updateA4Preview()
      
      if(useConfirmation) {
        formMessage.textContent = 'Formulir telah direset.';
        formMessage.className = 'text-sm text-gray-600';
      } else {
        formMessage.textContent = '';
      }
    }

    /* ------------------ FORM READONLY (LOCK) ------------------ */
    function setFormReadOnly(readonly) {
      formLockedForNota = !!readonly;
      $('kasir').disabled = readonly;
      $('pemohon').disabled = readonly;
      $('pekerjaan').disabled = readonly;
      itemSearchEl.disabled = readonly;
      itemQtyEl.disabled = readonly;
      tambahItemBtn.disabled = readonly;
      $('item-selected-display').disabled = readonly;
      jumlahBayarEl.disabled = readonly;
      namaBankEl.disabled = readonly;
      document.querySelectorAll('input[name="metode"]').forEach(r => r.disabled = readonly);
      saveBtn.disabled = readonly;
      cartItemsEl.querySelectorAll('button[data-idx]').forEach(btn => btn.disabled = readonly);

      if (!readonly) {
        const metode = document.querySelector('input[name="metode"]:checked')?.value || 'Cash';
        if (metode === 'Transfer') bankInputEl.classList.remove('hidden'); else bankInputEl.classList.add('hidden');
      } else {
        const metode = document.querySelector('input[name="metode"]:checked')?.value || 'Cash';
        if (metode === 'Transfer') bankInputEl.classList.remove('hidden'); else bankInputEl.classList.add('hidden');
      }
    }

    /* ------------------ UTIL ------------------ */
    function escapeHtml(s) {
      if (s === null || s === undefined) return '';
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }
    
    // --- FUNGSI TERBILANG ---
    function terbilang(angka) {
        var bilne = ["", "satu", "dua", "tiga", "empat", "lima", "enam", "tujuh", "delapan", "sembilan", "sepuluh", "sebelas"];
        if (angka < 12) {
            return bilne[angka];
        } else if (angka < 20) {
            return terbilang(angka - 10) + " belas";
        } else if (angka < 100) {
            return terbilang(Math.floor(angka / 10)) + " puluh " + terbilang(angka % 10);
        } else if (angka < 200) {
            return "seratus " + terbilang(angka - 100);
        } else if (angka < 1000) {
            return terbilang(Math.floor(angka / 100)) + " ratus " + terbilang(angka % 100);
        } else if (angka < 2000) {
            return "seribu " + terbilang(angka - 1000);
        } else if (angka < 1000000) {
            return terbilang(Math.floor(angka / 1000)) + " ribu " + terbilang(angka % 1000);
        } else if (angka < 1000000000) {
            return terbilang(Math.floor(angka / 1000000)) + " juta " + terbilang(angka % 1000000);
        } else if (angka < 1000000000000) {
            return terbilang(Math.floor(angka / 1000000000)) + " milyar " + terbilang(angka % 1000000000);
        } else if (angka < 1000000000000000) {
            return terbilang(Math.floor(angka / 1000000000000)) + " trilyun " + terbilang(angka % 1000000000000);
        }
        return "";
    }
  </script>
</body>
</html>
